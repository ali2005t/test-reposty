<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض الملزمة - Ta3leemy</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #1e293b;
            overflow: hidden;
        }

        .app-header {
            height: 60px;
            background: #0f172a;
            display: flex;
            align-items: center;
            padding: 0 20px;
            color: white;
            border-bottom: 1px solid #334155;
        }

        .viewer-container {
            height: calc(100vh - 60px);
            width: 100%;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .floating-watermark {
            position: absolute;
            color: rgba(255, 255, 255, 0.2);
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 60;
            pointer-events: none;
            white-space: nowrap;
            animation: moveWatermark 20s linear infinite alternate;
        }

        @keyframes moveWatermark {
            0% {
                top: 10%;
                left: 10%;
            }

            100% {
                top: 80%;
                left: 80%;
            }
        }

        @media print {
            html {
                display: none !important;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body oncontextmenu="return false;">

    <header class="app-header">
        <button onclick="window.close()"
            style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer; margin-left:15px;">
            <i class="fas fa-times"></i> إغلاق
        </button>
        <h3>عرض الملف</h3>
    </header>

    <div class="viewer-container">
        <iframe id="pdf-frame" src=""></iframe>
        <div class="floating-watermark" id="watermark"></div>
    </div>

    <!-- Security Script -->
    <script type="module">
        import { auth, db } from '../assets/js/firebase-config.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const params = new URLSearchParams(window.location.search);
        let url = params.get('url');

        // Convert View to Preview for cleaner interface
        if (url && url.includes('drive.google.com') && url.includes('/view')) {
            url = url.replace('/view', '/preview');
        }

        document.getElementById('pdf-frame').src = url;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docSnap = await getDoc(doc(db, "students", user.uid));
                let text = user.email;
                if (docSnap.exists()) text = `${docSnap.data().phone || ''} - ${docSnap.data().fullName || ''}`;
                document.getElementById('watermark').innerText = text;
            }
        });

        // Anti-Screenshot
        document.addEventListener('keyup', (e) => {
            if (e.key == 'PrintScreen') {
                navigator.clipboard.writeText('');
                alert('Screenshots disabled');
                document.body.style.display = 'none';
                setTimeout(() => document.body.style.display = 'block', 2000);
            }
        });

        window.addEventListener('blur', () => document.body.style.opacity = '0');
        window.addEventListener('focus', () => document.body.style.opacity = '1');

    </script>
</body>

</html>